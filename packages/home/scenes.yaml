automation:
  - alias: Set home mode to Home
    trigger:
      - platform: state
        entity_id: group.everyone
        to: home
    action:
      - service: scene.turn_on
        data:
          entity_id: scene.home

  - alias: Set home mode to Away
    trigger:
      - platform: state
        entity_id: group.everyone
        to: not_home
        for:
          minutes: 15
    action:
      - service: scene.turn_on
        data:
          entity_id: scene.away

  - alias: Turn off Night scene
    trigger:
      - platform: template
        value_template: "{{ states('sensor.time') == states('sensor.todays_alarm') }}"
    action:
      - service: scene.turn_on
        data:
          entity_id: scene.getting_up

  - alias: Begin syncing with time of day
    trigger:
      - platform: state
        entity_id: binary_sensor.toilet_motion
        to: "on"
    action:
      - service: script.do_initial_sync
      
  - alias: Notify when current scene and time of day are out of sync
    trigger:
      - platform: state
        entity_id: binary_sensor.current_scene_and_time_of_day_mismatch
        to: 'on'
    condition:
      - condition: state
        entity_id: group.everyone
        state: home
    action:
      - service: notify.mobile_app_pixel_4
        data:
          title: Current scene doesn't match time of day
          message: The currently active scene doesn't match the time of day
          data:
            actions:
              - action: scene_sync
                title: Fix now
  
  - alias: Sync scene when arriving home
    trigger:
      - platform: state
        entity_id: group.everyone
        to: home
    condition:
      condition: not
      conditions:
        - condition: state
          entity_id: sensor.time_of_day
          state: Night
    action:
      - service: script.scene_sync

  - alias: Turn on correct scene when arriving home at Night
    trigger:
      - platform: state
        entity_id: group.everyone
        to: home
    condition:
      - condition: state
        entity_id: sensor.time_of_day
        state: Night
    action:
      - service: scene.turn_on
        data_template:
          entity_id: "scene.{{ 'evening' if now().hour > 12 else 'morning' }}"

  - alias: Handle scene override
    trigger:
      - platform: state
        entity_id: input_select.presence
      - platform: state
        entity_id: input_select.scene
    action:
      - service: scene.turn_on
        data_template:
          entity_id: "scene.{{ trigger.to_state.state | lower | replace(' ', '_') }}"

binary_sensor:
  - platform: template
    sensors:
      current_scene_and_time_of_day_mismatch:
        friendly_name: Current scene and Time of Day mismatch
        delay_on:
          seconds: 5
        value_template: "{{ states('sensor.time_of_day') != states('sensor.current_scene') }}"
  - platform: workday
    country: NL
    name: Today is a workday
  - platform: workday
    country: NL
    name: Tomorrow is a workday
    days_offset: 1

group:
  all_scenes:
    entities:
      - scene.getting_up
      - scene.morning
      - scene.day
      - scene.afternoon
      - scene.early_evening
      - scene.evening
      - scene.night
    icon: mdi:theme-light-dark
    name: Scenes

input_datetime:
  workday_alarm:
    has_date: false
    has_time: true
    initial: "06:30"
    name: Workday alarm
  off_day_alarm:
    has_date: false
    has_time: true
    initial: "08:30"
    name: Off day alarm
  workday_bedtime:
    has_date: false
    has_time: true
    initial: "22:00"
    name: Workday bedtime
  off_day_bedtime:
    has_date: false
    has_time: true
    initial: "23:00"
    name: Off day bedtime

input_select:
  scene:
    icon: mdi:theme-light-dark
    name: Scene
    options:
      - Getting up
      - Morning
      - Day
      - Afternoon
      - Early evening
      - Evening
      - Night
      - Away

scene:
  - name: Home
    entities:
      input_select.presence: Home

  - name: Away
    entities:
      input_select.presence: Away
      input_select.scene: Away
      automation.begin_syncing_with_time_of_day: off
      automation.notify_when_current_scene_and_time_of_day_are_out_of_sync: off
      automation.synchronise_scene_to_time_of_day: off
      automation.turn_off_night_scene: off
      climate.living_room:
        state: heat
        temperature: 16
      input_boolean.keep_kitchen_spots_on: off
      light.kitchen_mood_lighting: off
      light.kitchen_spots: off
      light.kitchen_worktop: off
      light.living_room_pendant: off
      light.living_room_spots: off
      light.toilet_spot: off
      remote.harmony_hub: off
  
  - name: Getting up
    entities:
      input_select.presence: Home
      input_select.scene: Getting up
      automation.begin_syncing_with_time_of_day: on
      automation.notify_when_current_scene_and_time_of_day_are_out_of_sync: off
      automation.synchronise_scene_to_time_of_day: off
      automation.toggle_kitchen_spots_through_motion_sensor: off
      automation.turn_off_night_scene: off
      climate.living_room:
        state: heat
        temperature: 19
      light.kitchen_mood_lighting: off
      light.kitchen_spots: on
      light.kitchen_worktop: off
      light.living_room_pendant: on
      light.living_room_spots: off

  - name: Morning
    entities:
      input_select.presence: Home
      input_select.scene: Morning
      automation.begin_syncing_with_time_of_day: off
      automation.notify_when_current_scene_and_time_of_day_are_out_of_sync: on
      automation.synchronise_scene_to_time_of_day: on
      automation.toggle_kitchen_spots_through_motion_sensor: off
      automation.turn_off_night_scene: off
      climate.living_room:
        state: heat
        temperature: 19
      light.kitchen_mood_lighting: off
      light.kitchen_spots: on
      light.kitchen_worktop: off
      light.living_room_pendant: on
      light.living_room_spots: off

  - name: Day
    entities:
      input_select.presence: Home
      input_select.scene: Day
      automation.begin_syncing_with_time_of_day: off
      automation.notify_when_current_scene_and_time_of_day_are_out_of_sync: on
      automation.synchronise_scene_to_time_of_day: on
      automation.toggle_kitchen_spots_through_motion_sensor: on
      automation.turn_off_night_scene: off
      climate.living_room:
        state: heat
        temperature: 19
      light.kitchen_mood_lighting: off
      light.kitchen_worktop: off
      light.living_room_pendant: off
      light.living_room_spots: off

  - name: Afternoon
    entities:
      input_select.presence: Home
      input_select.scene: Afternoon
      automation.begin_syncing_with_time_of_day: off
      automation.notify_when_current_scene_and_time_of_day_are_out_of_sync: on
      automation.synchronise_scene_to_time_of_day: on
      automation.toggle_kitchen_spots_through_motion_sensor: on
      automation.turn_off_night_scene: off
      climate.living_room:
        state: heat
        temperature: 19
      light.kitchen_mood_lighting: on
      light.kitchen_worktop: off
      light.living_room_pendant: on
      light.living_room_spots: off

  - name: Early evening
    entities:
      input_select.presence: Home
      input_select.scene: Early evening
      automation.begin_syncing_with_time_of_day: off
      automation.notify_when_current_scene_and_time_of_day_are_out_of_sync: on
      automation.synchronise_scene_to_time_of_day: on
      automation.toggle_kitchen_spots_through_motion_sensor: on
      automation.turn_off_night_scene: off
      climate.living_room:
        state: heat
        temperature: 19
      light.kitchen_mood_lighting: on
      light.kitchen_worktop: off
      light.living_room_pendant: on
      light.living_room_spots:
        brightness: 65
        color_temp: 475
        state: on

  - name: Evening
    entities:
      input_select.presence: Home
      input_select.scene: Evening
      automation.begin_syncing_with_time_of_day: off
      automation.notify_when_current_scene_and_time_of_day_are_out_of_sync: on
      automation.synchronise_scene_to_time_of_day: on
      automation.toggle_kitchen_spots_through_motion_sensor: on
      automation.turn_off_night_scene: off
      climate.living_room:
        state: heat
        temperature: 19
      light.kitchen_mood_lighting: on
      light.kitchen_worktop: off
      light.living_room_pendant: on
      light.living_room_spots:
        brightness: 65
        color_temp: 475
        state: on

  - name: Night
    entities:
      input_select.presence: Home
      input_select.scene: Night
      automation.begin_syncing_with_time_of_day: off
      automation.notify_when_current_scene_and_time_of_day_are_out_of_sync: off
      automation.synchronise_scene_to_time_of_day: off
      automation.toggle_kitchen_spots_through_motion_sensor: on
      automation.turn_off_night_scene: on
      climate.living_room:
        state: heat
        temperature: 16
      input_boolean.keep_kitchen_spots_on: off
      light.kitchen_mood_lighting: off
      light.kitchen_spots: off
      light.kitchen_worktop: off
      light.living_room_pendant: off
      light.living_room_spots: off
      remote.harmony_hub: off

script:
  scene_selection_reactivate:
    alias: Reactivate primary scene
    sequence:
      - service: scene.turn_on
        data_template:
          entity_id: scene.{{ states('sensor.current_scene') | lower | replace(' ', '_') }}
  do_initial_sync:
    alias: Perform initial sync to time of day
    sequence:
      - service_template: "{{ 'scene' if is_state('sensor.time_of_day', 'Night') else 'script' }}.turn_on"
        data_template:
          entity_id: "{{ 'scene.morning' if is_state('sensor.time_of_day', 'Night') else 'script.scene_sync' }}"

sensor:
  - platform: template
    sensors:
      todays_alarm:
        friendly_name: Today's alarm
        value_template: "{{ state_attr('input_datetime.workday_alarm', 'timestamp') | int | timestamp_custom('%H:%M', False) if is_state('binary_sensor.today_is_a_workday', 'on') else state_attr('input_datetime.off_day_alarm', 'timestamp') | int | timestamp_custom('%H:%M', False) }}"
      current_scene:
        friendly_name: Current scene
        icon_template: mdi:theme-light-dark
        value_template: "{{ states('input_select.scene') }}"
  - platform: time_date
    display_options:
      - date
      - time
